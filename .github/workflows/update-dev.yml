name: Update Dev Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
        type: string

jobs:
  update-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: Install yq (Go version)
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Update Kustomize image tag for dev
        run: |
          yq -i '.images[0].newTag = strenv(IMAGE_TAG)' apps/demo-app/overlays/dev/kustomization.yaml
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}


      - name: Commit & Push
        run: |
          git config user.name "GitOps Bot"
          git config user.email "gitops-bot@your-org.com"

          git add apps/demo-app/overlays/dev/kustomization.yaml
          git commit -m "chore: update demo-app dev image to ${IMAGE_TAG}" || echo "no changes to commit"

          git push https://x-access-token:${GH_PAT}@github.com/${GITHUB_REPOSITORY}.git HEAD:main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}